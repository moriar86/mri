<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Marli Jump & Run</title>
  <style>
    body { margin: 0; overflow: hidden; background-color: lightblue; }
    canvas { display: block; background: skyblue; }
  </style>
</head>
<body>
<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// Asset-Pfade
const assets = {
  marli: "marli.png",
  knight: "knight.png",
  heart: "heart.png",
  avocado: "avocado.png",
  burrito: "burrito.png",
  milkshake: "milkshake.png"
};

// Bild-Loader
const images = {};
let loaded = 0;
const toLoad = Object.keys(assets).length;

for (let key in assets) {
  images[key] = new Image();
  images[key].src = assets[key];
  images[key].onload = () => {
    loaded++;
    if (loaded === toLoad) startGame();
  };
}

function startGame() {
  // Spielobjekte
  const groundY = canvas.height - 50;
  let marli = {
    x: 50, y: groundY - 70, width: 50, height: 70,
    dy: 0, gravity: 0.6, jumpPower: -12,
    isJumping: false, speed: 5, lives: 3
  };

  const enemies = []; // Mehrere Ritter
  const foods = [];   // Heil-Items
  const foodSprites = [images.avocado, images.burrito, images.milkshake];

  // Gegner erzeugen
  function spawnEnemy() {
    enemies.push({
      x: canvas.width + Math.random() * 300,
      y: groundY - 60,
      width: 50,
      height: 60,
      speed: 5,
      canHit: true,
      active: true
    });
  }

  // Essen erzeugen
  function spawnFood() {
    foods.push({
      x: canvas.width + Math.random() * 300,
      y: groundY - 40,
      width: 40,
      height: 40,
      sprite: foodSprites[Math.floor(Math.random() * foodSprites.length)]
    });
  }

  // Steuerung
  document.addEventListener("touchstart", () => {
    if (!marli.isJumping) {
      marli.dy = marli.jumpPower;
      marli.isJumping = true;
    }
  });

  function update() {
    // Bewegung
    marli.dy += marli.gravity;
    marli.y += marli.dy;

    if (marli.y + marli.height >= groundY) {
      marli.y = groundY - marli.height;
      marli.isJumping = false;
    }

    // Ritter bewegen & Kollision prüfen
    enemies.forEach((enemy, index) => {
      if (!enemy.active) return;
      enemy.x -= enemy.speed;

      if (enemy.x + enemy.width < 0) {
        enemies.splice(index, 1); // Aus dem Spiel entfernen
        return;
      }

      const hit =
        marli.x < enemy.x + enemy.width &&
        marli.x + marli.width > enemy.x &&
        marli.y < enemy.y + enemy.height &&
        marli.y + marli.height > enemy.y;

      if (hit) {
        if (marli.dy > 0) {
          // Ritter besiegt
          enemy.active = false;
        } else if (enemy.canHit) {
          marli.lives--;
          enemy.canHit = false;
          if (marli.lives <= 0) {
            alert("Game Over!");
            resetGame();
          }
        }
      }
    });

    // Essen bewegen & Kollision
    foods.forEach((food, index) => {
      food.x -= marli.speed;
      const collected =
        marli.x < food.x + food.width &&
        marli.x + marli.width > food.x &&
        marli.y < food.y + food.height &&
        marli.y + marli.height > food.y;

      if (collected) {
        if (marli.lives < 3) marli.lives++;
        foods.splice(index, 1);
      }
    });

    // Spawning
    if (Math.random() < 0.01) spawnEnemy();
    if (Math.random() < 0.005) spawnFood();

    // Geschwindigkeit langsam erhöhen
    if (marli.speed < 12) marli.speed += 0.0005;
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Boden
    ctx.fillStyle = "green";
    ctx.fillRect(0, groundY, canvas.width, 50);

    // Marli
    ctx.drawImage(images.marli, marli.x, marli.y, marli.width, marli.height);

    // Ritter
    enemies.forEach(enemy => {
      if (enemy.active)
        ctx.drawImage(images.knight, enemy.x, enemy.y, enemy.width, enemy.height);
    });

    // Essen
    foods.forEach(food => {
      ctx.drawImage(food.sprite, food.x, food.y, food.width, food.height);
    });

    // Leben (Herzen)
    for (let i = 0; i < marli.lives; i++) {
      ctx.drawImage(images.heart, 20 + i * 40, 20, 30, 30);
    }
  }

  function resetGame() {
    marli.lives = 3;
    marli.speed = 5;
    enemies.length = 0;
    foods.length = 0;
  }

  function gameLoop() {
    update();
    draw();
    requestAnimationFrame(gameLoop);
  }

  gameLoop();
}
</script>
</body>
</html>
